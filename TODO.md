## Trading module roadmap (спринты)

### Спринт 1 — Архитектура торгового модуля и конфиг

- **Режимы работы**:
  - Определить режимы: `SCREEN_ONLY`, `TRADE_PAPER`, `TRADE_LIVE`.
  - Решить, как текущий скринер будет работать в каждом режиме (при `SCREEN_ONLY` торговля полностью отключена).
- **Интерфейсы модулей**:
  - Спроектировать интерфейсы `TradingModule`, `ExecutionEngine`, `RiskManager` (какие методы, какие DTO).
  - Разделить ответственность: генерация сигналов (от скринера) vs исполнение сделок (execution).
- **ENV-конфиг для торговли** (без реализации логики):
  - `TRADE_ENABLED` (bool), `TRADE_MODE` (`SCREEN_ONLY` / `TRADE_PAPER` / `TRADE_LIVE`).
  - `TRADE_POSITION_SIZE_USD` — базовый размер позиции в $.
  - `TRADE_MAX_RISK_PER_TRADE` — макс. риск на сделку (в $ или % от депо, TBD).
  - `TRADE_MAX_OPEN_POSITIONS` — ограничение по числу одновременных позиций.
  - `TRADE_NATR_PERIOD=14` — период NATR.
  - `TRADE_NATR_TIMEFRAME=5m` — таймфрейм для расчёта NATR.
  - `TRADE_ENTRY_NATR_RANGE` — диапазон входа в NATR (например, `[1,2]`).
  - `TRADE_TP_NATR_LEVELS` — уровни тейк-профитов в NATR (например, `[2,3]`).
  - `TRADE_TP_PERCENTS` — проценты позиции по уровням, например `[50,50]`.
  - `TRADE_SL_TICK_OFFSET` — смещение SL на 1 тик за плотностью (можно как параметр).
  - Базовые лимиты: `TRADE_DAILY_MAX_LOSS`, `TRADE_DAILY_MAX_TRADES` (на будущее).
- **Документация**:
  - Описать все новые env-переменные в `README.md` (секция Trading config).
  - Добавить пояснение по режимам работы и ограничениям (особенно для `TRADE_LIVE`).

### Спринт 1 — Переключение режимов (скринер ↔ торговля)

- **Точка входа**:
  - Продумать, как в `index.ts` создавать/не создавать торговый модуль в зависимости от `TRADE_MODE`.
  - В режиме `SCREEN_ONLY` торговый модуль не инициализируется и не подписывается на сигналы.
- **Интеграция со скринером**:
  - Определить формат сигнала от скринера (структура «крупной заявки» для трейдинга).
  - Продумать, какие фильтры остаются в чистом скринере, а какие должны быть в торговом модуле.

### Спринт 2 — Данные и индикатор NATR(14) на 5m

- **Источник свечей**:
  - Выбрать источник 5m OHLCV (желательно Hyperliquid, чтобы не плодить сторонние зависимости).
  - Определить формат хранения свечей в памяти (per-coin буфер фиксированной длины).
- **Расчёт NATR(14)**:
  - Описать алгоритм расчёта NATR(14) для 5m (на основе ATR/True Range).
  - Продумать прогрев: минимальное количество свечей до начала торговли.
  - Спроектировать обновление NATR по мере прихода новых свечей.
- **API для торгового модуля**:
  - Предусмотреть простой метод типа `getNatr(coin): number | null`.
  - Определить поведение при отсутствии данных (нет свечей/не прогрето).

### Спринт 2 — Диапазоны в NATR

- **Диапазон входа**:
  - Формат конфигурации `TRADE_ENTRY_NATR_RANGE`, например `[1,2]` → вход в диапазоне 1–2 NATR от текущей цены.
  - Описать, как конвертировать `n * NATR` в абсолютный диапазон цены.
- **Диапазон раскидывания лимиток**:
  - Определить, как использовать NATR для размещения лимитных ордеров на вход и на выход.
  - Описать, как проверяем, что цена «подошла» к плотности в рамках диапазона.

### Спринт 3 — Логика сигнала от плотности

- **Базовые правила входа**:
  - Крупная лимитная заявка на **bid** → сценарий **лонг**.
  - Крупная лимитная заявка на **ask** → сценарий **шорт**.
- **Условия активации сигнала**:
  - Минимальная плотность в $ (использовать уже имеющиеся фильтры скринера).
  - Расстояние от текущей цены в NATR (вход/лимитки только в рамках заданного диапазона).
  - Проверка отсутствия противоречащей позиции по этой монете (не открывать второй лонг, если уже есть открытый).
- **Вход лимитом vs маркетом**:
  - Логика «лимиткой от плотности в диапазоне NATR».
  - Логика «по рынку, если цена подошла к плотности по рынку» (в пределах заданного NATR).
  - Сформулировать правила, когда мы предпочитаем лимитный вход, а когда — рыночный.

### Спринт 3 — Объём позиции

- **Расчёт размера**:
  - Использовать `TRADE_POSITION_SIZE_USD` как базу: `contracts = USD / price`.
  - Учитывать плечо и максимально допустимый риск (`TRADE_MAX_RISK_PER_TRADE`).
- **Проверки**:
  - Поведение при слишком большом размере относительно ликвидности/спреда.
  - Что делать при слишком узком диапазоне (частичный вход / отказ от сделки).

### Спринт 4 — Execution engine

- **Оркестрация ордеров**:
  - Спроектировать модуль, который умеет:
    - выставлять лимитный ордер на вход вблизи плотности в заданном диапазоне NATR;
    - отправлять рыночный ордер при подходе цены к плотности;
    - отслеживать статусы ордеров (частичное исполнение, полное исполнение, отмена).
- **Надёжность**:
  - Описать стратегию ретраев при ошибках/таймаутах API.
  - Учитывать rate-limit Hyperliquid (backoff, очередь запросов).
  - Не реализовывать пока конкретные HTTP/WebSocket вызовы — только интерфейсы и флоу.

### Спринт 4 — Stop-loss

- **Постановка SL**:
  - SL ставится сразу после открытия позиции.
  - Уровень: «за 1 тик за крупной заявкой» по направлению риска:
    - Лонг от bid-плотности → SL ниже плотности на 1 тик.
    - Шорт от ask-плотности → SL выше плотности на 1 тик.
- **Детали**:
  - Учесть размер тика инструмента (tickSize).
  - Рассмотреть вариант OCO-ордеров (TP+SL).
  - Продумать поведение, если исходная крупная лимитка исчезла/переставилась (двигать SL или нет).
- **SL по «разъеданию» и снятию плотности**:
  - При входе по крупной заявке фиксировать её исходный размер (например, 1М$) и цену.
  - Ввести параметр (или жёсткое правило), что если остаток заявки падает до ≤ X% от начального объёма (например, 30%) или до абсолютного минимума (например, ≤ 300K$), позиция закрывается (рыночным или лимитным выходом согласно конфигу).
  - Реализовать отслеживание: отличать ситуацию, когда:
    - заявка частично съедена, но остаток всё ещё виден в стакане;
    - заявка полностью снята/съедена в зоне видимости спрэда;
    - заявка просто ушла за границы видимости (цена ушла дальше, а не снятие).
  - Правило выхода:
    - Если заявка в зоне видимости **пропала по этой цене** или остаток ≤ порога → форсированный выход из позиции.
    - Если заявка просто ушла из видимой зоны из-за движения цены, но всё ещё существует дальше по стакану → решение по выходу принимать отдельно (не считать это автоматическим сигналом для SL).

### Спринт 5 — Лесенка тейк-профитов по NATR

- **Разбиение позиции**:
  - Использовать массивы, вроде `TRADE_TP_NATR_LEVELS=[2,3]` и `TRADE_TP_PERCENTS=[50,50]`.
  - Интерпретация: закрыть 50% позиции на `entryPrice ± 2*NATR`, 50% — на `entryPrice ± 3*NATR` (знак зависит от направления позиции).
- **Поведение**:
  - Обработать частичные исполнения по каждому уровню.
  - Логика обновления/отмены оставшихся TP после изменения позиции (частичное закрытие вручную, стоп и т.д.).

### Спринт 5 — Пер-коиновый трейд-конфиг

- **Персональные настройки на монету**:
  - Спроектировать env-переменную `TRADE_OVERRIDES` или аналог, в стиле:
    - `TRADE_OVERRIDES=BTC:{posSizeUsd:20000,entryRange:[1,2],tpLevels:[2,3],tpPercents:[50,50]};ETH:{...}`
  - Либо использовать более простой строковый формат по аналогии с `MIN_ORDER_SIZE_USD_OVERRIDES`.
- **Приоритеты**:
  - Описать порядок применения: сначала per-coin override, затем глобальные настройки.

### Спринт 6 — Режимы безопасности и тестирования

- **Режимы**:
  - `TRADE_MODE=SCREEN_ONLY` — только алерты, без торговли.
  - `TRADE_MODE=TRADE_PAPER` — paper/dry-run: сделки логируются и эмулируются (без реальных ордеров).
  - `TRADE_MODE=TRADE_LIVE` — реальные ордера (вводить только после полного тестирования).
- **Ограничения и защита**:
  - Максимум сделок за день (`TRADE_DAILY_MAX_TRADES`).
  - Максимальный дневной убыток (`TRADE_DAILY_MAX_LOSS`) с авто-отключением торговли.
  - Ограничение числа одновременных позиций.
  - Защита от повторных входов в одну и ту же плотность/уровень.
  - Обработка ошибок Hyperliquid (reject, timeout, disconnect) и аварийный стоп торговли при аномалиях.

### Спринт 6 — Мониторинг и логирование для торгового модуля

- **Логи**:
  - Структурированные логи с полями: `component` (screener/trading), `symbol`, `orderId`, `positionId`, `side`, `size`, `price`, `risk`.
  - Разделить информационные/отладочные/ошибки по уровням.
- **Уведомления**:
  - Отдельный Telegram-канал/чат для торговых событий (открытие/закрытие позиций, ошибки, отключение торговли).
- **Метрики**:
  - PnL по дням/неделям.
  - Hit-rate (доля успешных сделок).
  - Средний вход/выход в единицах NATR.
  - Визуализация и экспорт (на будущее: Prometheus/Grafana или простые CSV/JSON отчёты).


