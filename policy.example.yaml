# ====================================================================================================
# Конфигурация правил контекстного управления объёмом и риском (Спринт 9)
# ====================================================================================================
# 
# СТРУКТУРА ПРАВИЛА:
# ------------------
# - name: уникальное имя правила
#   priority: приоритет (меньше = выше приоритет, правила применяются по возрастанию priority)
#   scope: область применения
#     * new_entry: применяется при открытии новой позиции
#     * open_position: применяется к уже открытой позиции
#     * new_entry_breakdown: применяется при расчёте разбивки входа
#   when: условия активации (ВСЕ условия должны выполняться одновременно)
#   then: действия при активации (применяются если все условия when = true)
#
# ====================================================================================================
# ДОСТУПНЫЕ УСЛОВИЯ (when):
# ====================================================================================================
# 
# ОПЕРАТОРЫ:
# - Gte (Greater Than or Equal): >= (больше или равно)
# - Lte (Less Than or Equal): <= (меньше или равно)
# - Eq (Equal): == (точное совпадение)
#
# УСЛОВИЯ ПО NATR SHOCK (динамика волатильности):
# ------------------------------------------------
#   shock30mNatrGte: <число>    # Минимальный шок (>= X NATR за окно 1)
#   shock30mNatrLte: <число>    # Максимальный шок (<= X NATR за окно 1)
#   shock60mNatrGte: <число>    # Минимальный шок (>= X NATR за окно 2)
#   shock60mNatrLte: <число>    # Максимальный шок (<= X NATR за окно 2)
#   
#   Примечание: "30m" и "60m" - это названия, а не фиксированные значения!
#   Реальные окна настраиваются в .env:
#     POLICY_SHOCK_WINDOW1_MIN=30  # Окно 1 (по умолчанию 30 минут)
#     POLICY_SHOCK_WINDOW2_MIN=60  # Окно 2 (по умолчанию 60 минут)
#   
#   Shock = кумулятивное изменение цены в NATR за указанное окно
#   Пример: shock30mNatr=8 означает цена изменилась на 8 NATR за последние 30 минут
#
# УСЛОВИЯ ПО ЯКОРЮ (anchor memory - история взаимодействия с уровнем):
# ---------------------------------------------------------------------
#   anchorTradeCountGte: <число>       # Минимальное общее кол-во сделок (>= N)
#   anchorTradeCountLte: <число>       # Максимальное общее кол-во сделок (<= N)
#   anchorWinCountGte: <число>         # Минимальное кол-во профитных сделок (>= N)
#   anchorWinCountLte: <число>         # Максимальное кол-во профитных сделок (<= N)
#   anchorLastTradeAgoMinGte: <число>  # Минимум минут с последней сделки (>= N)
#   anchorLastTradeAgoMinLte: <число>  # Максимум минут с последней сделки (<= N)
#
# УСЛОВИЯ ПО ВРЕМЕНИ В ПОЗИЦИИ:
# ------------------------------
#   timeInAnchorZoneMinGte: <число>    # Минимум минут в зоне якоря (>= N)
#   timeInAnchorZoneMinLte: <число>    # Максимум минут в зоне якоря (<= N)
#   timeSinceEntryMinGte: <число>      # Минимум минут с момента входа (>= N)
#   timeSinceEntryMinLte: <число>      # Максимум минут с момента входа (<= N)
#
# УСЛОВИЯ ПО ТЕЙК-ПРОФИТАМ:
# --------------------------
#   tpHitsCountEq: <число>             # Точное количество достигнутых TP (== N)
#
# ====================================================================================================
# ДОСТУПНЫЕ ДЕЙСТВИЯ (then):
# ====================================================================================================
#
#   allowTrade: true/false          # Разрешить/запретить торговлю
#   sizeMultiplier: <число>         # Множитель размера позиции (1.0 = базовый, 2.0 = двойной, 0.5 = половина)
#   tpNatrMultiplier: <число>       # Множитель уровней TP в NATR (1.0 = базовый, 1.5 = дальше на 50%, 0.5 = ближе на 50%)
#   slNatrMultiplier: <число>       # Множитель уровней SL в NATR (пока не используется)
#
# ====================================================================================================
# ПРИМЕРЫ ИСПОЛЬЗОВАНИЯ ОПЕРАТОРОВ:
# ====================================================================================================
#
# ДИАПАЗОН (от A до B):
#   when:
#     shock30mNatrGte: 6    # >= 6
#     shock30mNatrLte: 12   # <= 12
#   → Сработает только если shock в диапазоне [6, 12]
#
# ТОЛЬКО МАЛЫЕ ЗНАЧЕНИЯ:
#   when:
#     shock30mNatrLte: 6    # <= 6
#   → Сработает только если shock <= 6 (слабое движение)
#
# ТОЛЬКО БОЛЬШИЕ ЗНАЧЕНИЯ:
#   when:
#     shock60mNatrGte: 20   # >= 20
#   → Сработает только если shock >= 20 (экстремальное движение)
#
# СВЕЖИЙ ЯКОРЬ (первая сделка):
#   when:
#     anchorTradeCountLte: 0  # <= 0 (ещё не было сделок)
#   → Сработает только для нового якоря
#
# ЯКОРЬ С ИСТОРИЕЙ:
#   when:
#     anchorTradeCountGte: 3   # >= 3 (было хотя бы 3 сделки)
#   → Сработает только если якорь уже использовался
#
# ====================================================================================================

# ====================================================================================================
# АКТИВНЫЕ ПРАВИЛА (по умолчанию)
# ====================================================================================================

rules:
  # ============================================================
  # Правило 1: ЗАЩИТА ОТ ПЕРЕТОРГОВЛИ
  # Если от уровня было 5+ профитных сделок, больше не торгуем
  # ============================================================
  - name: too_many_wins_on_anchor
    priority: 1
    scope: new_entry
    when:
      anchorWinCountGte: 5          # >= 5 профитных трейдов
    then:
      allowTrade: false             # Запрещаем дальнейшую торговлю

  # ============================================================
  # Правило 2: УМЕРЕННОЕ ДВИЖЕНИЕ
  # При нормальном шоке используем базовый размер
  # ============================================================
  - name: shock_30m_normal
    priority: 10
    scope: new_entry
    when:
      shock30mNatrGte: 6            # Шок >= 6 NATR (есть движение)
    then:
      sizeMultiplier: 1.0           # Базовый размер позиции
      tpNatrMultiplier: 1.0         # Базовые уровни TP

  # ============================================================
  # Правило 3: СИЛЬНЫЙ ТРЕНД
  # При мощном шоке увеличиваем размер и отодвигаем TP
  # ============================================================
  - name: shock_60m_strong
    priority: 9
    scope: new_entry
    when:
      shock60mNatrGte: 12           # Шок >= 12 NATR (сильное движение)
    then:
      sizeMultiplier: 2.0           # Удваиваем размер позиции
      tpNatrMultiplier: 1.2         # TP дальше на 20%

  # ============================================================
  # Правило 4: РЕТЕСТ УРОВНЯ
  # Если возвращаемся к якорю через 3+ часа, снижаем риск
  # ============================================================
  - name: anchor_retest_smaller
    priority: 8
    scope: new_entry
    when:
      anchorTradeCountGte: 1        # Уже была >= 1 сделка
      anchorLastTradeAgoMinGte: 180 # Прошло >= 180 минут (3 часа)
    then:
      sizeMultiplier: 0.5           # Половина размера
      tpNatrMultiplier: 0.7         # TP ближе на 30%

  # ============================================================
  # Правило 5: ДОЛГОЕ СТОЯНИЕ У ЯКОРЯ
  # Если позиция простояла 40+ минут без TP, подтягиваем уровни
  # ============================================================
  - name: long_time_near_anchor
    priority: 7
    scope: open_position
    when:
      timeInAnchorZoneMinGte: 40    # Стоим >= 40 минут
      tpHitsCountEq: 0              # Ни один TP не достигнут
    then:
      tpNatrMultiplier: 0.5         # Подтягиваем TP ближе на 50%

# ====================================================================================================
# ДОПОЛНИТЕЛЬНЫЕ ПРИМЕРЫ ПРАВИЛ (закомментированы)
# ====================================================================================================

# ============================================================
# ПРИМЕР 1: ЭКСТРЕМАЛЬНЫЙ SHOCK
# Агрессивная торговля при супер-сильном движении
# ============================================================
# - name: extreme_shock_aggressive
#   priority: 5
#   scope: new_entry
#   when:
#     shock60mNatrGte: 20             # Экстремальный шок >= 20 NATR
#   then:
#     sizeMultiplier: 3.0             # Утраиваем размер
#     tpNatrMultiplier: 1.5           # TP дальше на 50%

# ============================================================
# ПРИМЕР 2: ДИАПАЗОН SHOCK (от 6 до 12 NATR)
# Используем комбинацию Gte и Lte для определения диапазона
# ============================================================
# - name: shock_30m_moderate_range
#   priority: 10
#   scope: new_entry
#   when:
#     shock30mNatrGte: 6              # >= 6 NATR
#     shock30mNatrLte: 12             # <= 12 NATR (итого: 6-12 NATR)
#   then:
#     sizeMultiplier: 1.0
#     tpNatrMultiplier: 1.0

# ============================================================
# ПРИМЕР 3: СЛАБОЕ ДВИЖЕНИЕ
# Не торгуем если shock слишком маленький
# ============================================================
# - name: weak_movement_skip
#   priority: 15
#   scope: new_entry
#   when:
#     shock30mNatrLte: 6              # <= 6 NATR (слабое движение)
#   then:
#     allowTrade: false               # Не торгуем

# ============================================================
# ПРИМЕР 4: ОГРАНИЧЕНИЕ ПО КОЛ-ВУ СДЕЛОК
# Максимум 3 сделки с одного якоря
# ============================================================
# - name: max_trades_per_anchor
#   priority: 5
#   scope: new_entry
#   when:
#     anchorTradeCountGte: 3          # Уже было >= 3 сделок
#   then:
#     allowTrade: false               # Больше не торгуем

# ============================================================
# ПРИМЕР 5: ТОЛЬКО СВЕЖИЕ ЯКОРЯ
# Торгуем только с новых уровней (0 сделок)
# ============================================================
# - name: only_fresh_anchors
#   priority: 2
#   scope: new_entry
#   when:
#     anchorTradeCountLte: 0          # <= 0 сделок (новый якорь)
#   then:
#     sizeMultiplier: 1.0
#     tpNatrMultiplier: 1.0

# ============================================================
# ПРИМЕР 6: КОНСЕРВАТИВНЫЙ ПЕРВЫЙ ТРЕЙД
# Снижаем риск на первой сделке с якоря
# ============================================================
# - name: first_trade_conservative
#   priority: 11
#   scope: new_entry
#   when:
#     anchorTradeCountLte: 0          # Первая сделка
#   then:
#     sizeMultiplier: 0.8             # Меньше размер на 20%
#     tpNatrMultiplier: 0.9           # TP ближе на 10%

# ============================================================
# ПРИМЕР 7: БЫСТРОЕ ЗАКРЫТИЕ ПРИ ЗАСТОЕ
# Если 20+ минут без движения, подтягиваем TP
# ============================================================
# - name: quick_exit_no_movement
#   priority: 6
#   scope: open_position
#   when:
#     timeInAnchorZoneMinGte: 20      # Стоим >= 20 минут
#     tpHitsCountEq: 0                # Ни один TP не достигнут
#   then:
#     tpNatrMultiplier: 0.3           # Очень близко к цене входа

# ============================================================
# ПРИМЕР 8: НЕДАВНИЙ РЕТЕСТ (до 1 часа)
# Если возвращаемся к якорю быстро, торгуем агрессивнее
# ============================================================
# - name: recent_retest_aggressive
#   priority: 12
#   scope: new_entry
#   when:
#     anchorTradeCountGte: 1          # Была хотя бы 1 сделка
#     anchorLastTradeAgoMinLte: 60    # Прошло <= 60 минут (1 час)
#   then:
#     sizeMultiplier: 1.2             # Увеличиваем на 20%
#     tpNatrMultiplier: 1.1           # TP дальше на 10%

# ============================================================
# ПРИМЕР 9: ТОЛЬКО ПРОФИТНЫЕ ЯКОРЯ
# Торгуем только с уровней где уже была хотя бы 1 прибыльная сделка
# ============================================================
# - name: only_winning_anchors
#   priority: 3
#   scope: new_entry
#   when:
#     anchorWinCountGte: 1            # Была >= 1 профитная сделка
#     anchorWinCountLte: 4            # Но < 5 (не перегорели)
#   then:
#     sizeMultiplier: 1.5             # Увеличиваем размер на 50%

# ============================================================
# ПРИМЕР 10: КОМБО - СИЛЬНЫЙ SHOCK + СВЕЖИЙ ЯКОРЬ
# Идеальные условия: сильное движение + новый уровень
# ============================================================
# - name: combo_strong_shock_fresh_anchor
#   priority: 4
#   scope: new_entry
#   when:
#     shock60mNatrGte: 15             # Сильный шок
#     anchorTradeCountLte: 0          # Новый якорь
#   then:
#     sizeMultiplier: 2.5             # Очень агрессивно
#     tpNatrMultiplier: 1.3           # TP дальше на 30%

# ====================================================================================================
# РЕКОМЕНДАЦИИ ПО НАСТРОЙКЕ
# ====================================================================================================
#
# 1. PRIORITY (приоритет):
#    - Меньшее число = выше приоритет
#    - Правила применяются по возрастанию priority
#    - Если несколько правил подходят, применяется первое (с наименьшим priority)
#    - Рекомендация: 
#      * 1-5: критические блокировки (allowTrade: false)
#      * 6-10: основные правила размера/TP
#      * 11+: второстепенные корректировки
#
# 2. SIZE MULTIPLIER (множитель размера):
#    - 0.5 = половина базового размера (консервативно)
#    - 1.0 = базовый размер (стандарт)
#    - 2.0 = удвоенный размер (агрессивно)
#    - 3.0+ = очень агрессивно (только при экстремальных условиях)
#    - Не рекомендуется > 3.0 (слишком высокий риск)
#
# 3. TP NATR MULTIPLIER (множитель уровней TP):
#    - 0.3 = очень близко к цене входа (быстрый выход)
#    - 0.5 = половина стандартного расстояния
#    - 1.0 = стандартное расстояние
#    - 1.5 = на 50% дальше (для трендов)
#    - 2.0+ = очень далеко (только при сильных трендах)
#
# 4. SHOCK WINDOWS (окна расчёта шока):
#    В .env настраиваются:
#      POLICY_SHOCK_WINDOW1_MIN=30  # "shock30m" → фактически 30 минут
#      POLICY_SHOCK_WINDOW2_MIN=60  # "shock60m" → фактически 60 минут
#    
#    Рекомендуемые значения shock:
#      - < 4 NATR: очень слабое движение, лучше не торговать
#      - 4-8 NATR: умеренное движение, стандартный размер
#      - 8-15 NATR: сильное движение, можно увеличить размер
#      - 15-25 NATR: очень сильное движение, агрессивно
#      - > 25 NATR: экстремальное движение, осторожно (возможен откат)
#
# 5. ANCHOR MEMORY (память по якорям):
#    - anchorTradeCount: общее кол-во сделок (профитные + убыточные)
#    - anchorWinCount: только профитные сделки
#    - anchorLastTradeAgoMin: минуты с последней сделки
#    
#    Стратегии:
#      a) Торговать только с новых якорей (anchorTradeCountLte: 0)
#      b) Избегать "горячих" якорей (anchorWinCountGte: 5 → allowTrade: false)
#      c) Снижать риск на ретестах (anchorTradeCountGte: 1 → sizeMultiplier: 0.5)
#      d) Агрессивнее на быстрых ретестах (anchorLastTradeAgoMinLte: 60 → sizeMultiplier: 1.2)
#
# 6. TIME IN ZONE (время в зоне якоря):
#    - Если позиция долго не двигается → подтянуть TP ближе
#    - Рекомендация: 
#      * 20-30 минут: начать подтягивать TP (tpNatrMultiplier: 0.7)
#      * 40+ минут: агрессивно подтянуть (tpNatrMultiplier: 0.3-0.5)
#
# 7. TESTING (тестирование):
#    - Начните с консервативных значений (sizeMultiplier: 0.5-1.0)
#    - Тестируйте на PAPER режиме (TRADE_MODE=TRADE_PAPER)
#    - Анализируйте логи: grep "политика применена" logs/trading_*.log
#    - Постепенно увеличивайте агрессивность при хороших результатах
#
# 8. ПРИМЕР БАЗОВОЙ СТРАТЕГИИ:
#    1. Блокировать якоря после 5 профитных сделок (защита от переторговли)
#    2. Торговать только при shock >= 6 NATR (есть движение)
#    3. Увеличить размер при shock >= 12 NATR (сильный тренд)
#    4. Снизить риск на ретестах через 3+ часа
#    5. Подтянуть TP если стоим > 40 минут без движения
#
# ====================================================================================================


